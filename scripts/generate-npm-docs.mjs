import fs from 'fs';
import path from 'path';

const MODULES_DIR = path.join(process.cwd(), 'docs-src', 'npm-module');
const SOURCES_FILE = path.join(MODULES_DIR, 'sources.txt');
const GEN_DIR = path.join(MODULES_DIR, 'generated');
const RSPRESS_GEN_DIR = path.join(process.cwd(), '.rspress');
const SIDEBAR_OUTPUT_PATH = path.join(RSPRESS_GEN_DIR, 'npm-sidebar.ts');

// --- Helper Functions ---

function parseMetadata(content) {
  const metadata = {};
  const commentMatch = content.match(/<!--\s*([\s\S]*?)\s*-->/);
  if (commentMatch) {
    const metadataLines = commentMatch[1].trim().split('\n');
    for (const line of metadataLines) {
      const match = line.match(/(\w+):\s*(.*)/);
      if (match) {
        metadata[match[1].trim()] = match[2].trim();
      }
    }
  }
  return metadata;
}

function extractMainContent(content) {
  return content.replace(/<!--\s*([\s\S]*?)\s*-->/, '').trim();
}


// --- Main Logic ---

async function main() {
  console.log('Starting NPM Modules documentation generation...');

  if (!fs.existsSync(SOURCES_FILE)) {
    console.log('No sources.txt file found. Skipping NPM modules generation.');
    fs.writeFileSync(SIDEBAR_OUTPUT_PATH, 'export const npmSidebar = [];');
    return;
  }

  if (!fs.existsSync(GEN_DIR)) {
    fs.mkdirSync(GEN_DIR, { recursive: true });
  }
  if (!fs.existsSync(RSPRESS_GEN_DIR)) {
    fs.mkdirSync(RSPRESS_GEN_DIR, { recursive: true });
  }

  const urls = fs.readFileSync(SOURCES_FILE, 'utf-8').split('\n').filter(line => !line.startsWith('#') && line.trim() !== '');
  const modulePages = [];
  const modulesData = [];

  for (const url of urls) {
    try {
      console.log(`Fetching: ${url}`);
      const response = await fetch(url);
      if (!response.ok) {
        console.error(`[ERROR] Failed to fetch ${url}: ${response.statusText}`);
        continue;
      }
      const rawContent = await response.text();
      const metadata = parseMetadata(rawContent);
      const mainContent = extractMainContent(rawContent);

      if (!metadata.name) {
        console.error(`[ERROR] Could not parse "name" from ${url}. Skipping.`);
        continue;
      }

      const moduleName = metadata.name.split('/').pop();
      const generatedFileName = `${moduleName}.md`;
      const generatedFilePath = path.join(GEN_DIR, generatedFileName);

      const pageContent = mainContent;
      fs.writeFileSync(generatedFilePath, pageContent);
      console.log(`[SUCCESS] Generated page for ${moduleName}`);

      const moduleLink = `/npm-module/generated/${moduleName}`;
      modulePages.push({
        text: moduleName,
        link: moduleLink,
      });
      modulesData.push({ ...metadata, link: moduleLink });

    } catch (error) {
      console.error(`[ERROR] An error occurred while processing ${url}:`, error);
    }
  }

  // --- Index Page Generation ---
  let indexContent = '# NPM Modules\n\n';
  indexContent += '| Module | Version | Description | Repository |\n';
  indexContent += '| --- | --- | --- | --- |\n';
  modulesData.forEach(mod => {
    const moduleName = `[${mod.name}](${mod.link})`;
    const version = mod.version || '';
    const description = mod.description || '';
    const gitUrl = mod.giturl ? `[GitHub](${mod.giturl})` : '';
    indexContent += `| ${moduleName} | ${version} | ${description} | ${gitUrl} |\n`;
  });
  fs.writeFileSync(path.join(MODULES_DIR, 'index.md'), indexContent);
  console.log(`[SUCCESS] Generated index page at ${path.join(MODULES_DIR, 'index.md')}`);

  // --- Sidebar Generation ---
  const sidebarItems = [
    {
      text: 'NPM Modules',
      link: '/npm-module/'
    },
    ...modulePages.map(page => ({
      text: page.text,
      link: page.link
    }))
  ];

  const sidebarContent = `// This file is auto-generated by scripts/generate-npm-docs.mjs\n// Do not edit this file directly.\n\nexport const npmSidebar = ${JSON.stringify(sidebarItems, null, 2)};\n`;

  fs.writeFileSync(SIDEBAR_OUTPUT_PATH, sidebarContent);
  console.log(`[SUCCESS] Generated sidebar at ${SIDEBAR_OUTPUT_PATH}`);

  console.log('NPM Modules documentation generation complete.');
}

main().catch(console.error);
